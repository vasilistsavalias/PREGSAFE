# 0.README-r_service

## 1. Overview

The `r_service` module is a standalone microservice responsible for serving the new suite of machine learning models developed in R. It is built using the `plumber` library to create a RESTful API and is containerized with Docker for portability and production deployment.

Its primary purpose is to expose the complex, multi-model prediction logic from the `PREGSAFE_prediction.R` script as a secure, performant, and reliable API endpoint that the main Python backend can communicate with.

## 2. Folder Structure

```r_service
r_service/
│
├── models/                   # All .Rda model and feature files
│   ├── smote_model.Rda
│   └── ... (8 other files)
├── tests/                    # Test suite for the R code
│   └── test_predictions.R
│
├── Dockerfile                # Instructions for building the Docker container
├── main.R                    # Plumber API entrypoint and routing
├── model_loader.R            # Script to load all models into memory at startup
└── prediction_logic.R        # Refactored core prediction and feature engineering logic
```

## 3. Core Logic and Design Reasoning

This service is architected for performance and reliability, addressing the critical feedback from the initial plan.

* **Efficient Model Loading:** The most significant design choice is the separation of model loading from prediction. The `model_loader.R` script is executed **only once** when the service starts. It loads all **40 new `.Rda` files** (representing 8 suites × 5 algorithms) from disk into a single `res_ML` list in memory.
* **Performant Predictions:** The `/predict` endpoint, which is called on every request, uses the pre-loaded models from memory. This avoids slow, repetitive file I/O and ensures low-latency predictions.
* **Simplified Inputs:** The logic has been refactored to accept clinically friendly inputs: **Gestational Age in Weeks** (float), **ART Conception** (boolean), and **BMI** (float), reducing frontend complexity.
* **Robustness:** The `main.R` entrypoint includes structured logging (`logger`), robust error handling (`tryCatch`), and basic input validation to prevent crashes and provide meaningful error messages.
* **Security:** The service is secured with a shared secret API key. The `main.R` script includes a Plumber filter that checks for a valid `X-API-Key` header on all prediction requests, ensuring that only the authorized Python backend can access it.

## 4. File Breakdown

* **`main.R`**: The Plumber API entrypoint. It initializes the logger, loads the models at startup, sources the prediction logic, and defines the `/predict` and `/health` endpoints.

* **`model_loader.R`**: Contains the `load_all_models` function, which is responsible for loading all `.Rda` files from the `/models` directory into a single, globally available list.
* **`prediction_logic.R`**: The refactored version of the original script. It contains the `engineering_feats` and `PREGSAFE_prediction_sample` functions but has been modified to be stateless and accept the pre-loaded models list as an argument.
* **`Dockerfile`**: A production-hardened Dockerfile that builds a secure, efficient, and reproducible image of the R service. It installs dependencies (`randomForest`, `xgboost`, `e1071`), sets up a non-root user, and defines the startup command.
* **`tests/test_predictions.R`**: A test suite using the `testthat` library to verify the correctness of the prediction logic.

## 5. Setup and Local Testing

This service is designed to be run inside Docker.

### 1. Build the Docker Image

```powershell
# From the project root directory:
docker build -t r-service-local ./r_service
```

### 2. Run the Docker Container

```powershell
# This command runs the container and maps your local port 8000 to the container's port 8000
docker run -p 8000:8000 --name r-service-container r-service-local
```

### 3. Test the Service

You can test the running service using `curl` from your terminal.

```powershell
curl -X POST "http://localhost:8000/predict" \
-H "Content-Type: application/json" \
-H "X-API-Key: a-secure-secret-key" \
-d 
'{
  "maternal_age": "35",
  "Wt_pre": "70",
  "height": "165",
  "Wgain": "12",
  "GA_weeks": "28.5",
  "conception_art": "false",
  "bmi": "25.7",
  "SDG_option": "smote",
  "algorithm_option": "RF_model"
}'
```

## 6. Notes for Integration

* The service runs on port `8000` inside its container.

* It expects an `X-API-Key` header for all requests to `/predict`.
* The Python backend is responsible for calling this service, providing the API key, and handling any network-related issues like timeouts or retries.

---

## 7. Key Architectural Decisions & Troubleshooting

This section documents the reasoning behind key technical decisions and solutions to problems encountered during development.

### Decision: Efficient Model Loading at Startup

* **Problem:** The original R script loaded a model from disk on every single prediction request. This would cause extremely high latency under any real-world load.

* **Solution:** The code was refactored into three parts: `model_loader.R` loads all models into memory once at startup, `prediction_logic.R` contains the core functions (now stateless), and `main.R` orchestrates this. This ensures that predictions are fast as they only access objects in memory.

### Troubleshooting: R Service Startup Failures

* **Problem:** The R service would fail to start or would exit immediately when run from the command line with `Rscript`. This was caused by several issues:
    1. **Missing Packages:** The local and Docker R environments were missing critical packages required by the models (e.g., `caret`, `xgboost`, `naivebayes`).
    2. **Working Directory:** `Rscript` was being run from the project root, so it couldn't find the script files using relative paths.
    3. **Incorrect Command:** The command `Rscript main.R` only executes the script and exits. It does not run a persistent server. The command `R -e "..."` had quoting issues with PowerShell.

* **Solution:**
    1. The required packages were identified and are now explicitly installed in the `Dockerfile`.
    2. The startup command now uses the `plumber::pr_run()` function, which is the correct way to launch a persistent Plumber server. The final, PowerShell-safe command is included in the VS Code `restore-terminals.json` configuration.

### Decision: Hardened Dockerfile

* **Problem:** A basic `Dockerfile` can be fragile and insecure.

* **Solution:** The `Dockerfile` for this service is "hardened" by:
  * Using a specific, versioned base image (`rocker/r-ver:4.3.2`) for reproducibility.
  * Installing known system dependencies (`libssl-dev`, etc.) to prevent R package installation failures.
  * Creating and running the service as a non-root user (`appuser`) for improved security.

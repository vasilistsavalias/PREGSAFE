# 0.README-backend

## 1. Overview

The `backend` module serves as the core logic and data orchestration layer for the PREGSAFE application. It is a FastAPI-based Python server responsible for handling API requests, processing data, running machine learning predictions, and interacting with the database. The primary philosophy is to maintain a clean, modular, and scalable architecture with a clear separation of concerns between the API, business logic, and data layers.

## 2. Folder Structure

```backend
backend/
│
├── alembic/                  # Alembic migration scripts
├── app/                      # Core application logic
│   ├── api/                  # API endpoints
│   ├── core/                 # Configuration
│   ├── db/                   # Database session and base models
│   ├── schemas/              # Pydantic schemas for data validation
│   └── services/             # Business logic for predictions
├── models/                   # Trained machine learning models
│   └── predictor.pkl         # CTGAN-based predictor
│
├── alembic.ini               # Alembic configuration
├── main.py                   # FastAPI application entry point
├── requirements.txt          # Python dependencies
├── start.py                  # Start script for production environments
└── train_predictor.py        # Script to train the CTGAN-based predictor
```

## 3. Core Logic and Design Reasoning

The backend is designed around a standard three-tier architecture, but with a key difference: it acts as both a model server and an API gateway.

* **API Layer (`app/api`)**: Defines the public-facing API endpoints that the frontend consumes.
* **Service Layer (`app/services`)**: Contains the core business logic. It handles two distinct tasks:
    1. **Internal Predictions ("Optimal"):** Formerly a local Python model, this has been refactored to act as a **proxy** to the R Service (specifically requesting the CTGAN + XGBoost model). This ensures mathematical consistency across the platform while preserving the API structure.
    2. **Advanced Predictions:** Proxies to the R Service for user-selected model combinations (e.g., SMOTE + Random Forest).
* **Data Layer (`app/db`)**: Manages all database interactions with the SQLite database.

This unified approach centralizes validation and ensures that all predictions, whether "simple" or "advanced," are generated by the validated R models.

## 4. File Breakdown

* **main.py**: The main entry point for the FastAPI application.
* **start.py**: A simple script to start the Uvicorn server for production.
* **requirements.txt**: Lists all Python dependencies, including `httpx` for making requests to the R service.
* **app/api/endpoints/predictions.py**: Defines all API endpoints, including `/predict-ctgan` and the new `/predict-advanced`.
* **app/services/prediction_service.py**: Implements the core logic. This is the most important file for understanding the hybrid architecture. It contains both the `predict_with_ctgan` function for local predictions and the `predict_with_r_models` function that communicates with the external R service.
* **train_predictor.py**: A script to train the Random Forest classifier on data synthetically balanced with CTGAN.

## 5. Setup and Installation

### Windows (PowerShell)

```powershell
# 1. Navigate to the backend directory
cd backend

# 2. Create a virtual environment
python -m venv venv

# 3. Activate the virtual environment
.\venv\Scripts\Activate.ps1

# 4. Install the required dependencies
pip install -r requirements.txt

# 5. Run database migrations
alembic upgrade head
```

### Linux (bash)

```bash
# 1. Navigate to the backend directory
cd backend

# 2. Create a virtual environment
python3 -m venv venv

# 3. Activate the virtual environment
source venv/bin/activate

# 4. Install the required dependencies
pip install -r requirements.txt

# 5. Run database migrations
alembic upgrade head
```

## 6. Running the Module

### Windows

```powershell
# Run the FastAPI server (now defaults to port 8008)
uvicorn main:app --reload --port 8008
```

### Linux

```bash
# Run the FastAPI server (now defaults to port 8008)
uvicorn main:app --reload --port 8008
```

## 7. Common Issues & Fixes

* **Port already in use**: If you get an error that the port is already in use, you can either stop the process that is using the port or run the server on a different port.
* **R Service Connection Error**: If you see `503 Service Unavailable` or `502 Bad Gateway` errors, it means the backend cannot communicate with the R service. Ensure the R service is running and that the `R_SERVICE_URL` environment variable is correctly pointing to it (default is `http://localhost:8000`).

## 8. Notes for Integration

The backend exposes a RESTful API that the frontend can interact with. The main endpoints are:

* `POST /api/v1/predict-ctgan`: Get a prediction (Proxies to R Service: CTGAN+XGBoost).
* `POST /api/v1/predict-advanced`: Get a prediction using the external R microservice. This endpoint accepts `sdg_option` and `algorithm_option` in the request body.
* `GET /api/v1/history`: Retrieve the history of all predictions.
* `DELETE /api/v1/history/{prediction_id}`: Delete a prediction from the history.

**Key Schema Changes:**

* Inputs now expect `gestational_age_weeks` (float) instead of days.
* New optional fields: `conception_art` (boolean) and `bmi` (float).
